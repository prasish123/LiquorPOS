# Docker Compose configuration for Redis Sentinel High Availability
# This file sets up a complete Redis Sentinel cluster with 1 master, 2 replicas, and 3 sentinels

version: '3.8'

services:
  # Redis Master
  redis-master:
    image: redis:7-alpine
    container_name: redis-master
    command: >
      redis-server
      --requirepass ${REDIS_PASSWORD:-changeme}
      --masterauth ${REDIS_PASSWORD:-changeme}
      --appendonly yes
      --appendfsync everysec
    ports:
      - "6379:6379"
    volumes:
      - redis-master-data:/data
    networks:
      - redis-network
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "${REDIS_PASSWORD:-changeme}", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5

  # Redis Replica 1
  redis-replica-1:
    image: redis:7-alpine
    container_name: redis-replica-1
    command: >
      redis-server
      --replicaof redis-master 6379
      --requirepass ${REDIS_PASSWORD:-changeme}
      --masterauth ${REDIS_PASSWORD:-changeme}
      --appendonly yes
      --appendfsync everysec
    ports:
      - "6380:6379"
    volumes:
      - redis-replica-1-data:/data
    networks:
      - redis-network
    depends_on:
      redis-master:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "${REDIS_PASSWORD:-changeme}", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5

  # Redis Replica 2
  redis-replica-2:
    image: redis:7-alpine
    container_name: redis-replica-2
    command: >
      redis-server
      --replicaof redis-master 6379
      --requirepass ${REDIS_PASSWORD:-changeme}
      --masterauth ${REDIS_PASSWORD:-changeme}
      --appendonly yes
      --appendfsync everysec
    ports:
      - "6381:6379"
    volumes:
      - redis-replica-2-data:/data
    networks:
      - redis-network
    depends_on:
      redis-master:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "${REDIS_PASSWORD:-changeme}", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5

  # Sentinel 1
  redis-sentinel-1:
    image: redis:7-alpine
    container_name: redis-sentinel-1
    command: >
      sh -c "
      echo 'port 26379' > /tmp/sentinel.conf &&
      echo 'sentinel monitor mymaster redis-master 6379 2' >> /tmp/sentinel.conf &&
      echo 'sentinel auth-pass mymaster ${REDIS_PASSWORD:-changeme}' >> /tmp/sentinel.conf &&
      echo 'sentinel down-after-milliseconds mymaster 5000' >> /tmp/sentinel.conf &&
      echo 'sentinel parallel-syncs mymaster 1' >> /tmp/sentinel.conf &&
      echo 'sentinel failover-timeout mymaster 10000' >> /tmp/sentinel.conf &&
      redis-sentinel /tmp/sentinel.conf
      "
    ports:
      - "26379:26379"
    networks:
      - redis-network
    depends_on:
      redis-master:
        condition: service_healthy
    restart: always

  # Sentinel 2
  redis-sentinel-2:
    image: redis:7-alpine
    container_name: redis-sentinel-2
    command: >
      sh -c "
      echo 'port 26379' > /tmp/sentinel.conf &&
      echo 'sentinel monitor mymaster redis-master 6379 2' >> /tmp/sentinel.conf &&
      echo 'sentinel auth-pass mymaster ${REDIS_PASSWORD:-changeme}' >> /tmp/sentinel.conf &&
      echo 'sentinel down-after-milliseconds mymaster 5000' >> /tmp/sentinel.conf &&
      echo 'sentinel parallel-syncs mymaster 1' >> /tmp/sentinel.conf &&
      echo 'sentinel failover-timeout mymaster 10000' >> /tmp/sentinel.conf &&
      redis-sentinel /tmp/sentinel.conf
      "
    ports:
      - "26380:26379"
    networks:
      - redis-network
    depends_on:
      redis-master:
        condition: service_healthy
    restart: always

  # Sentinel 3
  redis-sentinel-3:
    image: redis:7-alpine
    container_name: redis-sentinel-3
    command: >
      sh -c "
      echo 'port 26379' > /tmp/sentinel.conf &&
      echo 'sentinel monitor mymaster redis-master 6379 2' >> /tmp/sentinel.conf &&
      echo 'sentinel auth-pass mymaster ${REDIS_PASSWORD:-changeme}' >> /tmp/sentinel.conf &&
      echo 'sentinel down-after-milliseconds mymaster 5000' >> /tmp/sentinel.conf &&
      echo 'sentinel parallel-syncs mymaster 1' >> /tmp/sentinel.conf &&
      echo 'sentinel failover-timeout mymaster 10000' >> /tmp/sentinel.conf &&
      redis-sentinel /tmp/sentinel.conf
      "
    ports:
      - "26381:26379"
    networks:
      - redis-network
    depends_on:
      redis-master:
        condition: service_healthy
    restart: always

networks:
  redis-network:
    driver: bridge

volumes:
  redis-master-data:
  redis-replica-1-data:
  redis-replica-2-data:

