// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum Role {
  ADMIN
  MANAGER
  CASHIER
}

enum OverrideReason {
  PRICE_MATCH
  DAMAGED_GOODS
  CUSTOMER_SATISFACTION
  OTHER
}

model User {
  id        String   @id @default(uuid())
  username  String   @unique
  password  String   // Hashed
  pin       String?  // Quick access for cashiers, 4-6 digits (hashed)
  firstName String
  lastName  String
  role      Role     @default(CASHIER)
  active    Boolean  @default(true)
  
  priceOverrides  PriceOverride[] @relation("ManagerOverrides")
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Product {
  id          String   @id @default(uuid())
  sku         String   @unique
  upc         String?  @unique
  name        String
  description String?
  category    String   // wine, beer, spirits, mixers, snacks
  
  // Liquor-specific
  abv         Float?   // Alcohol by volume
  volumeMl    Int?     // Bottle size in ml
  caseSize    Int?     // Bottles per case
  
  // Pricing
  basePrice   Float
  cost        Float    // For margin tracking
  
  // Inventory
  trackInventory Boolean @default(true)
  
  // Compliance
  ageRestricted Boolean @default(false)
  
  // AI Search (will be used for vector embeddings)
  searchText  String?  // Concatenated text for search
  embedding   String?  // JSON string of embedding vector
  
  // Relations
  inventory   Inventory[]
  images      ProductImage[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([category])
  @@index([sku])
  @@index([searchText])
}

model ProductImage {
  id         String  @id @default(uuid())
  productId  String
  url        String
  isPrimary  Boolean @default(false)
  
  product    Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  
  @@index([productId])
}

model Inventory {
  id          String   @id @default(uuid())
  productId   String
  locationId  String
  
  quantity    Int      // Current stock
  reserved    Int      @default(0) // Reserved for online orders
  reorderPoint Int?    // Alert threshold
  
  product     Product  @relation(fields: [productId], references: [id])
  location    Location @relation(fields: [locationId], references: [id])
  
  updatedAt   DateTime @updatedAt
  
  @@unique([productId, locationId])
  @@index([locationId])
}

model Location {
  id             String   @id @default(uuid())
  name           String
  address        String
  city           String
  state          String
  zip            String
  
  // Tax configuration
  taxRate        Float    @default(0.07) // Default 7% (Florida state tax)
  countyTaxRate  Float?   // Optional county-specific tax
  
  // Florida license
  licenseNumber  String?
  licenseExpiry  DateTime?
  
  // Receipt configuration
  receiptHeader  String?  // Custom header text
  receiptFooter  String?  // Custom footer text (e.g., "Thank you!")
  
  inventory        Inventory[]
  transactions     Transaction[]
  paymentTerminals PaymentTerminal[]
  
  createdAt      DateTime @default(now())
}

model Transaction {
  id              String   @id @default(uuid())
  locationId      String
  terminalId      String?
  employeeId      String?
  customerId      String?
  
  // Transaction details
  subtotal        Float
  tax             Float
  discount        Float    @default(0)
  total           Float
  
  // Payment
  paymentMethod   String   // cash, card, split
  paymentStatus   String   // completed, refunded, partial_refund
  
  // Source
  channel         String   // counter, web, uber_eats, doordash
  
  // Compliance
  ageVerified     Boolean  @default(false)
  ageVerifiedBy   String?
  idScanned       Boolean  @default(false)
  
  // Sync status
  syncedToCloud   Boolean  @default(false)
  syncedToBackOffice Boolean @default(false)
  
  // Idempotency
  idempotencyKey  String?  @unique
  
  items            TransactionItem[]
  payments         Payment[]
  priceOverrides   PriceOverride[]
  receipt          Receipt?
  complianceEvents ComplianceEvent[]
  location         Location @relation(fields: [locationId], references: [id])
  customer         Customer? @relation(fields: [customerId], references: [id])
  
  createdAt        DateTime @default(now())
  
  @@index([locationId])
  @@index([customerId])
  @@index([createdAt])
  @@index([locationId, createdAt])
  @@index([idempotencyKey])
}

model TransactionItem {
  id              String      @id @default(uuid())
  transactionId   String
  
  sku             String
  name            String
  quantity        Int
  unitPrice       Float
  discount        Float       @default(0)
  tax             Float
  total           Float
  
  // Price override tracking
  originalPrice   Float?      // Set if price was overridden
  priceOverridden Boolean     @default(false)
  
  transaction     Transaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)
  
  @@index([transactionId])
}

model Payment {
  id            String      @id @default(uuid())
  transactionId String
  
  method        String      // cash, card, gift_card
  amount        Float
  
  // Card details (tokenized)
  cardType      String?     // visa, mastercard, amex
  last4         String?
  
  // Payment processor
  processorId   String?     // Stripe payment intent ID
  status        String      // authorized, captured, failed
  
  transaction   Transaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)
  
  createdAt     DateTime    @default(now())
  
  @@index([transactionId])
}

model Customer {
  id              String   @id @default(uuid())
  email           String?  @unique
  phone           String?  @unique
  firstName       String
  lastName        String
  
  // Loyalty
  loyaltyPoints   Int      @default(0)
  lifetimeValue   Float    @default(0)
  
  // Compliance
  ageVerified     Boolean  @default(false)
  dateOfBirth     DateTime?
  idScanUrl       String?  // S3 URL for ID scan
  
  transactions    Transaction[]
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

model EventLog {
  id          String   @id @default(uuid())
  eventType   String   // order.created, inventory.updated, etc.
  aggregateId String?  // order_id, sku, etc.
  timestamp   DateTime @default(now())
  locationId  String?
  payload     String   // JSON
  metadata    String?  // JSON (user_id, ip_address, etc.)
  processed   Boolean  @default(false)
  processedAt DateTime?
  
  @@index([eventType])
  @@index([aggregateId])
  @@index([timestamp])
  @@index([locationId])
}

model AuditLog {
  id          String   @id @default(uuid())
  eventType   String   // PAYMENT_ACCESS, AGE_VERIFICATION, etc.
  userId      String?
  action      String
  resourceId  String?
  timestamp   DateTime @default(now())
  ipAddress   String?
  userAgent   String?
  result      String   // success, failure
  details     String?  // JSON
  
  @@index([eventType])
  @@index([userId])
  @@index([timestamp])
}

model PriceOverride {
  id              String         @id @default(uuid())
  transactionId   String
  itemId          String
  
  // Override details
  originalPrice   Float
  overridePrice   Float
  reason          OverrideReason
  reasonNotes     String?        // For "OTHER" reason
  
  // Manager approval
  managerId       String
  managerName     String         // Cached for audit trail
  approvedAt      DateTime       @default(now())
  
  // Audit trail
  cashierId       String?
  cashierName     String?
  terminalId      String?
  
  transaction     Transaction @relation(fields: [transactionId], references: [id])
  manager         User @relation("ManagerOverrides", fields: [managerId], references: [id])
  
  @@index([transactionId])
  @@index([managerId])
  @@index([approvedAt])
}

model Receipt {
  id              String   @id @default(uuid())
  transactionId   String   @unique
  
  // Receipt content (pre-rendered for reprints)
  content         String   // Plain text receipt
  htmlContent     String?  // HTML version for browser print
  
  // Metadata
  printedAt       DateTime?
  reprintCount    Int      @default(0)
  lastReprintAt   DateTime?
  
  transaction     Transaction @relation(fields: [transactionId], references: [id])
  
  createdAt       DateTime @default(now())
  
  @@index([transactionId])
}

model PaymentTerminal {
  id              String    @id @default(uuid())
  name            String
  type            String    // pax, ingenico, verifone, virtual
  locationId      String
  
  // Connection details
  ipAddress       String?
  port            Int?
  serialNumber    String?   @unique
  model           String?
  
  // Status
  enabled         Boolean   @default(true)
  firmwareVersion String?
  lastHeartbeat   DateTime?
  
  // Metadata
  metadata        String?   // JSON for additional config
  
  // Soft delete
  deletedAt       DateTime?
  
  location        Location  @relation(fields: [locationId], references: [id])
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  @@index([locationId])
  @@index([type])
  @@index([enabled])
  @@index([serialNumber])
}

model PaxTransaction {
  id                String   @id @default(uuid())
  terminalId        String
  transactionId     String?  // Link to main Transaction if applicable
  
  // Transaction details
  transactionType   String   // sale, refund, void, auth, capture
  amount            Float
  referenceNumber   String   @unique
  invoiceNumber     String?
  
  // Response details
  success           Boolean
  responseCode      String
  responseMessage   String
  authCode          String?
  
  // Card details
  cardType          String?
  last4             String?
  
  // Metadata
  rawRequest        String?  // JSON of request
  rawResponse       String?  // JSON of response
  
  createdAt         DateTime @default(now())
  
  @@index([terminalId])
  @@index([transactionId])
  @@index([referenceNumber])
  @@index([createdAt])
}

model ComplianceEvent {
  id            String   @id @default(uuid())
  transactionId String
  eventType     String   // age_verification, id_scan, etc.
  verified      Boolean
  verifiedBy    String?  // User ID who verified
  metadata      String?  // JSON with additional details
  
  transaction   Transaction @relation(fields: [transactionId], references: [id])
  
  createdAt     DateTime @default(now())
  
  @@index([transactionId])
  @@index([eventType])
  @@index([createdAt])
}
