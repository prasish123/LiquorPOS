# ==============================================================================
# SPARC v0.7 COMPLIANCE ANALYSIS
# ==============================================================================
# Generated: 2026-01-05
# Authority: SPARC v0.7 is the source of truth
# Scope: Gaps, violations, risks, and release blockers
# ==============================================================================

gaps:
  
  functional_gaps:
    
    - sparc_section: "workflows.price_override_authorization"
      description: |
        SPARC defines complete price override workflow (lines 575-608), including
        ManagerOverride modal integration into POS flow. OBSERVED: Component exists
        (frontend/src/components/ManagerOverride.tsx) but NOT integrated into POS
        terminal. No UI trigger to request price override.
      severity: HIGH
      evidence:
        - observed_flows.yaml lines 290-309 (manager role)
        - observed_flows.yaml lines 371-384 (brittle behaviors)
        - "SPARC line 607: integration_gap: ManagerOverride component exists but not integrated into POS UI"
      business_impact: |
        Managers cannot override prices for damaged goods, price matching, or
        customer satisfaction from POS terminal. Must use backend API directly,
        which is not practical for retail floor operations.
      
    - sparc_section: "workflows.receipt_generation"
      description: |
        SPARC defines receipt generation workflow (lines 663-680) with frontend
        integration. OBSERVED: Backend API exists and works, but frontend Checkout
        component does NOT call receipt API after successful transaction.
      severity: HIGH
      evidence:
        - observed_flows.yaml lines 245-249 (cashier brittle behaviors)
        - "SPARC line 679: integration_gap: Frontend doesn't call receipt API after checkout"
      business_impact: |
        Cashiers cannot print receipts for customers from POS terminal. Violates
        basic retail POS expectations. Customers have no proof of purchase.
      
    - sparc_section: "domains.reporting_and_analytics"
      description: |
        SPARC defines reporting capabilities (lines 438-461) including daily sales,
        inventory reports, and employee performance with export formats. OBSERVED:
        Backend APIs fully implemented, but frontend admin panel shows MOCK DATA.
        No backend integration.
      severity: HIGH
      evidence:
        - observed_flows.yaml lines 315-322 (manager admin panel access)
        - observed_flows.yaml lines 359-369 (manager dashboard flow)
        - observed_flows.yaml lines 391-395 (manager reporting gap)
      business_impact: |
        Managers cannot view real sales data, inventory levels, or employee
        performance. Cannot generate reports for business decisions or compliance.
        Admin panel is UI-only facade.
      
    - sparc_section: "domains.product_catalog"
      description: |
        SPARC defines product management capabilities (lines 109-160). OBSERVED:
        Backend APIs exist (POST/GET/PUT/DELETE /api/products), but frontend admin
        panel shows mock data. No create/edit/delete functionality in UI.
      severity: HIGH
      evidence:
        - observed_flows.yaml lines 362-369 (manager tries to add product)
        - observed_flows.yaml lines 372-377 (admin panel is facade)
      business_impact: |
        Managers cannot add new products, update prices, or manage inventory from
        UI. Must use backend API docs or database directly. Not practical for
        non-technical staff.
      
    - sparc_section: "domains.customer_management"
      description: |
        SPARC defines customer management capabilities (lines 299-324) including
        customer registration, loyalty points, and purchase history. OBSERVED:
        Backend APIs exist, but NO frontend UI for customer lookup or management.
      severity: MEDIUM
      evidence:
        - observed_flows.yaml lines 533-534 (POS limitations)
        - Checkout.tsx does not include customer lookup
      business_impact: |
        Cashiers cannot look up customers by phone/email, cannot apply loyalty
        points, cannot view purchase history. Loyalty program unusable from POS.
      
    - sparc_section: "domains.location_management"
      description: |
        SPARC defines location management (lines 389-414) with tax rate
        configuration per location. OBSERVED: Tax rate hardcoded at 7% in
        frontend CartLogic.ts. Does not fetch from Location.taxRate.
      severity: HIGH
      evidence:
        - observed_flows.yaml lines 227-232 (cashier brittle behaviors)
        - observed_flows.yaml lines 567-570 (cross-role observations)
        - observed_system.yaml lines 308-311 (tax calculation invariant)
      business_impact: |
        Multi-location deployments with different tax rates will calculate
        incorrect totals. Violates tax compliance requirements. Each location
        requires separate frontend build with hardcoded tax rate.
      
    - sparc_section: "non_functional.security.webhook_signature_verification"
      description: |
        SPARC defines webhook signature verification (lines 1092-1094) with gap
        noted for Uber Eats/DoorDash. OBSERVED: Stripe signature verified, but
        Uber Eats and DoorDash signatures NOT implemented. Logs warning but
        accepts unauthenticated webhooks.
      severity: HIGH
      evidence:
        - observed_system.yaml lines 410-424 (Uber Eats/DoorDash integrations)
        - "SPARC line 728: security_gap: Signature verification not implemented"
      business_impact: |
        Security vulnerability. Malicious actors can inject fake orders from
        delivery platforms. No authentication on webhook endpoints. Risk of
        fraudulent transactions and inventory manipulation.
      
    - sparc_section: "non_functional.operability.backup_restore_testing"
      description: |
        SPARC defines backup mechanisms (lines 1244-1253) but notes no automated
        restore testing. OBSERVED: Backups created with checksum verification,
        but never restored to verify integrity.
      severity: MEDIUM
      evidence:
        - observed_non_functional.yaml lines 797-799 (missing protections)
        - "SPARC line 1252: No automated restore testing"
      business_impact: |
        Backups may be corrupted or incomplete. Cannot guarantee successful
        disaster recovery. RPO/RTO targets unverified. Risk of data loss in
        emergency.
      
    - sparc_section: "non_functional.observability.metrics_export"
      description: |
        SPARC defines metrics collection (lines 1128-1139) but notes no
        Prometheus exporter or Grafana dashboard. OBSERVED: Metrics collected
        in-memory but not exported.
      severity: MEDIUM
      evidence:
        - observed_non_functional.yaml lines 736-739 (missing protections)
        - "SPARC lines 1136-1138: gaps - No Prometheus exporter, No Grafana dashboard"
      business_impact: |
        Cannot visualize system performance, business metrics, or trends.
        No dashboards for operations team. Reactive rather than proactive
        monitoring.
      
    - sparc_section: "non_functional.security.data_encryption_at_rest"
      description: |
        SPARC defines data protection (lines 1074-1084) with gap noted: only
        audit logs encrypted, database not encrypted at rest. OBSERVED: AES-256-GCM
        for audit logs only.
      severity: MEDIUM
      evidence:
        - observed_non_functional.yaml lines 791-794 (missing protections)
        - "SPARC lines 1081-1083: gaps - Database not encrypted at rest"
      business_impact: |
        Customer PII, payment data, and transaction history stored unencrypted.
        Compliance risk for PCI DSS and data protection regulations. Risk of
        data breach if database files compromised.
      
    - sparc_section: "workflows.offline_transaction_sync"
      description: |
        SPARC defines offline sync workflow (lines 731-753) with automatic
        processing every 5 minutes. OBSERVED: Backend implementation exists
        (OfflineQueueService) but NO frontend offline indicator or queue status.
      severity: MEDIUM
      evidence:
        - observed_flows.yaml lines 551-554 (offline mode untested)
        - observed_non_functional.yaml lines 81-105 (offline queue implementation)
      business_impact: |
        Cashiers have no visibility into offline mode status. Cannot tell if
        transactions are queued or synced. Risk of confusion during network
        outages. Unclear if offline mode actually works in production.
  
  non_functional_gaps:
    
    - sparc_section: "non_functional.scalability.horizontal_scaling"
      description: |
        SPARC defines single-instance deployment (lines 1027-1034) with no
        built-in clustering. OBSERVED: In-memory cache and rate limits not
        shared across instances.
      severity: MEDIUM
      evidence:
        - observed_non_functional.yaml lines 631-636 (single-instance assumption)
        - "SPARC lines 1030-1032: limitations - In-memory cache not shared, Rate limits not shared"
      business_impact: |
        Cannot scale horizontally without manual configuration. Rate limits
        ineffective across multiple instances. Cache inconsistency. Single
        point of failure for backend.
      
    - sparc_section: "non_functional.observability.distributed_tracing"
      description: |
        SPARC defines tracing with correlation IDs (lines 1141-1149) but notes
        no distributed tracing (OpenTelemetry, Jaeger). OBSERVED: Correlation
        IDs only, no span tracking.
      severity: LOW
      evidence:
        - observed_non_functional.yaml lines 731-734 (missing distributed tracing)
        - "SPARC lines 1147-1148: gaps - No distributed tracing"
      business_impact: |
        Cannot trace request flow across services. Difficult to debug
        performance issues or failures in multi-service workflows. Limited
        visibility into SAGA orchestration steps.
      
    - sparc_section: "non_functional.reliability.error_handling"
      description: |
        SPARC defines error handling (lines 916-926) with ISSUE noted:
        unhandledRejection does NOT terminate process. OBSERVED: Logs warning
        but continues running.
      severity: MEDIUM
      evidence:
        - observed_non_functional.yaml lines 27-38 (global error handlers)
        - "SPARC line 925: issue: unhandledRejection does NOT terminate process (potential memory leak)"
      business_impact: |
        Unhandled promise rejections may cause memory leaks. Process continues
        running in degraded state. Risk of cascading failures or resource
        exhaustion. Should terminate and restart via process manager.
      
    - sparc_section: "non_functional.security.secret_management"
      description: |
        SPARC defines configuration management (lines 1211-1222) with gap:
        no secret rotation or Vault integration. OBSERVED: Secrets in .env
        file, manual rotation required.
      severity: MEDIUM
      evidence:
        - observed_non_functional.yaml lines 647-656 (secrets in env vars)
        - observed_non_functional.yaml lines 756-759 (missing secret management)
        - "SPARC lines 1219-1221: gaps - No secret rotation, No Vault integration"
      business_impact: |
        Secrets stored in plaintext .env file. No audit trail for secret
        access. Manual rotation process error-prone. Risk of secret exposure
        in logs, version control, or backups.
      
    - sparc_section: "non_functional.availability.single_point_of_failure"
      description: |
        SPARC defines availability (lines 953-976) with PostgreSQL as single
        point of failure. OBSERVED: No automatic failover for database.
      severity: HIGH
      evidence:
        - observed_non_functional.yaml lines 509-522 (PostgreSQL unavailable scenario)
        - "SPARC line 965: single_point_of_failure: PostgreSQL (no built-in failover)"
      business_impact: |
        Database failure causes complete system outage. Manual intervention
        required. RTO depends on human response time. No automatic failover
        or replica promotion. Violates 99.9% availability target.

violations:
  
  - invariant_id: "invariants.tax_calculation"
    description: |
      SPARC invariant (lines 839-845) states "Tax calculated from location-specific
      rates" with Location.taxRate as source. VIOLATION: Frontend CartLogic.ts
      hardcodes 7% tax rate instead of fetching from backend.
    evidence:
      - frontend/src/domain/CartLogic.ts (hardcoded 0.07 tax rate)
      - observed_flows.yaml lines 227-232 (cashier brittle behaviors)
      - "SPARC line 844: issue: Tax rate hardcoded at 7% in frontend CartLogic.ts"
    severity: HIGH
    actual_behavior: |
      Frontend calculates tax at 7% regardless of Location.taxRate or
      Location.countyTaxRate. Backend trusts frontend calculation (PricingAgent).
      Multi-location deployments with different tax rates calculate incorrect totals.
    compliance_risk: |
      Tax compliance violation. Incorrect tax collection in jurisdictions with
      rates != 7%. Potential legal liability and audit failures.
  
  - invariant_id: "invariants.receipt_persistence"
    description: |
      SPARC invariant (lines 864-869) states "Receipt content stored for reprints"
      via Receipt table. VIOLATION: Frontend does NOT call receipt generation API
      after checkout, so receipts are never created.
    evidence:
      - frontend/src/components/Checkout.tsx (no receipt API call)
      - observed_flows.yaml lines 245-249 (no receipt printing from frontend)
      - "SPARC line 679: integration_gap: Frontend doesn't call receipt API after checkout"
    severity: HIGH
    actual_behavior: |
      Transactions complete successfully but Receipt records never created.
      Receipt.printedAt, Receipt.reprintCount never tracked. Customers cannot
      receive receipts. No reprint capability.
    compliance_risk: |
      Violates retail POS expectations and potentially tax/audit requirements
      for proof of purchase. Customer dissatisfaction.
  
  - invariant_id: "invariants.price_override_authorization"
    description: |
      SPARC invariant (lines 812-820) states "Price overrides require manager/admin
      PIN authentication" with PriceOverrideService validation. VIOLATION: No UI
      mechanism to trigger price override, making invariant unenforceable in practice.
    evidence:
      - frontend/src/components/ManagerOverride.tsx exists but not integrated
      - observed_flows.yaml lines 290-309 (price override theoretical)
      - "SPARC line 607: integration_gap: ManagerOverride component exists but not integrated into POS UI"
    severity: MEDIUM
    actual_behavior: |
      Backend enforces PIN validation and audit logging correctly. However,
      frontend has no way to request override. Component exists but orphaned.
      Managers must use backend API directly, bypassing frontend workflow.
    compliance_risk: |
      Audit trail incomplete. Price overrides done via API may not capture
      cashier context. Workaround bypasses intended workflow controls.
  
  - invariant_id: "non_functional.reliability.error_handling"
    description: |
      SPARC non-functional requirement (lines 916-926) expects process termination
      on unhandledRejection for fail-fast behavior. VIOLATION: Process logs warning
      but continues running.
    evidence:
      - backend/src/main.ts setupGlobalErrorHandlers()
      - observed_non_functional.yaml lines 27-38
      - "SPARC line 925: issue: unhandledRejection does NOT terminate process (potential memory leak)"
    severity: MEDIUM
    actual_behavior: |
      Unhandled promise rejections logged but process continues. May accumulate
      memory leaks or run in degraded state. No automatic restart.
    operational_risk: |
      Process may degrade over time. Memory leaks accumulate. Requires manual
      monitoring and restart. Violates fail-fast principle.

risks:
  
  - description: "Admin panel is non-functional facade"
    business_impact: |
      HIGH RISK: Managers and admins cannot perform critical operations from UI:
      - Cannot manage products (add, edit, delete, price changes)
      - Cannot manage users (create cashiers, update roles)
      - Cannot view real sales data or reports
      - Cannot manage inventory levels
      - Cannot configure system settings
      
      Workaround requires API knowledge (Postman, curl, Swagger docs), which is
      not practical for retail managers. Severely limits operational capability.
    evidence:
      - observed_flows.yaml lines 315-322 (admin panel mock data)
      - observed_flows.yaml lines 540-549 (backend feature-complete, frontend not)
    likelihood: CERTAIN (already exists)
    mitigation: |
      Connect frontend admin panel to backend APIs or provide comprehensive API
      documentation and training for non-technical staff.
  
  - description: "Tax calculation violates multi-location requirement"
    business_impact: |
      HIGH RISK: System cannot support multiple store locations with different
      tax rates. Hardcoded 7% in frontend violates SPARC's location-specific
      tax configuration. Each location requires separate frontend build.
      
      Incorrect tax collection creates legal and compliance liability. Potential
      audit failures and penalties from tax authorities.
    evidence:
      - frontend/src/domain/CartLogic.ts (hardcoded 0.07)
      - SPARC lines 839-845 (tax calculation invariant)
    likelihood: HIGH (if deploying to multiple locations)
    mitigation: |
      Fetch Location.taxRate from backend during checkout. Remove hardcoded
      tax rate. Validate tax calculation in backend PricingAgent.
  
  - description: "Webhook security vulnerability (Uber Eats, DoorDash)"
    business_impact: |
      HIGH RISK: Unauthenticated webhooks from delivery platforms can be spoofed.
      Malicious actors can inject fake orders, manipulate inventory, or cause
      fraudulent transactions. No signature verification implemented.
      
      Logs warning but accepts all webhooks. Creates audit trail of vulnerability
      awareness without remediation.
    evidence:
      - backend/src/webhooks/webhooks.controller.ts
      - observed_system.yaml lines 410-424
      - SPARC line 728 (security_gap)
    likelihood: MEDIUM (requires attacker knowledge of webhook format)
    mitigation: |
      Implement signature verification for Uber Eats and DoorDash webhooks.
      Reject unauthenticated requests. Document signature validation process.
  
  - description: "No receipt printing breaks customer experience"
    business_impact: |
      HIGH RISK: Customers cannot receive receipts for purchases. Violates basic
      retail POS expectations. Creates customer dissatisfaction and potential
      disputes. May violate tax/audit requirements for proof of purchase.
      
      Backend API works but frontend never calls it. Complete disconnect between
      implementation and usage.
    evidence:
      - observed_flows.yaml lines 245-249
      - SPARC lines 663-680 (receipt generation workflow)
    likelihood: CERTAIN (already exists)
    mitigation: |
      Integrate receipt generation into Checkout.tsx success flow. Call
      POST /receipts/:transactionId/generate after transaction completion.
      Display receipt or trigger print dialog.
  
  - description: "Offline mode untested and unverified"
    business_impact: |
      MEDIUM RISK: Offline mode implementation exists (OfflinePaymentAgent,
      OfflineQueueService) but unclear if it works. No frontend indicator for
      offline status. No visibility into queue processing.
      
      If offline mode fails in production, cashiers cannot process card payments
      during network outages. Risk of lost sales and customer frustration.
    evidence:
      - observed_flows.yaml lines 551-554
      - observed_non_functional.yaml lines 81-105
    likelihood: MEDIUM (depends on network reliability)
    mitigation: |
      Test offline mode thoroughly. Add frontend offline indicator. Display
      queue status to cashiers. Verify payment capture after sync.
  
  - description: "Database encryption gap creates compliance risk"
    business_impact: |
      MEDIUM RISK: Customer PII, payment data, and transaction history stored
      unencrypted in PostgreSQL. Only audit logs encrypted. Violates PCI DSS
      requirements for cardholder data protection.
      
      Risk of data breach if database files, backups, or volumes compromised.
      Potential regulatory penalties and customer trust damage.
    evidence:
      - observed_non_functional.yaml lines 791-794
      - SPARC lines 1081-1083
    likelihood: LOW (requires physical/logical access to database files)
    mitigation: |
      Enable PostgreSQL encryption at rest. Use encrypted volumes. Consider
      managed database services with built-in encryption. Encrypt backups.
  
  - description: "Single point of failure (PostgreSQL)"
    business_impact: |
      HIGH RISK: Database failure causes complete system outage. No automatic
      failover. Manual intervention required. RTO depends on human response time.
      
      Violates 99.9% availability target (inferred in SPARC). Risk of extended
      downtime during database failures, hardware issues, or maintenance.
    evidence:
      - observed_non_functional.yaml lines 509-522
      - SPARC line 965
    likelihood: LOW (depends on infrastructure reliability)
    mitigation: |
      Deploy PostgreSQL with replication and automatic failover (e.g., Patroni,
      managed RDS). Implement health checks and automatic failover logic.
      Test disaster recovery procedures.
  
  - description: "Unhandled promise rejections may cause memory leaks"
    business_impact: |
      MEDIUM RISK: Process continues running after unhandled promise rejections.
      May accumulate memory leaks or run in degraded state. No automatic restart.
      
      Risk of gradual performance degradation, memory exhaustion, or cascading
      failures. Requires manual monitoring and intervention.
    evidence:
      - backend/src/main.ts setupGlobalErrorHandlers()
      - SPARC line 925
    likelihood: LOW (depends on code quality and error handling)
    mitigation: |
      Change unhandledRejection handler to terminate process (process.exit(1)).
      Deploy with process manager (PM2, systemd) for automatic restart.
      Monitor for unhandled rejections in production.
  
  - description: "No backup restore testing creates false confidence"
    business_impact: |
      MEDIUM RISK: Backups created daily with checksum verification, but never
      restored to verify integrity. Cannot guarantee successful disaster recovery.
      
      Risk of discovering backup corruption during emergency. RPO/RTO targets
      unverified. Potential data loss if backups unusable.
    evidence:
      - observed_non_functional.yaml lines 797-799
      - SPARC line 1252
    likelihood: LOW (depends on backup process reliability)
    mitigation: |
      Implement automated restore testing (e.g., restore to test database weekly).
      Verify restored data integrity. Document and test disaster recovery procedures.
  
  - description: "Environment variable validation gaps in frontend"
    business_impact: |
      MEDIUM RISK: Missing VITE_LOCATION_ID or VITE_TERMINAL_ID causes runtime
      errors. Validation logs warning but checkout proceeds with invalid data.
      Backend may reject or create transactions with invalid location.
      
      Risk of data integrity issues, incorrect reporting, or transaction failures.
    evidence:
      - observed_flows.yaml lines 233-238 (missing env vars)
      - observed_flows.yaml lines 573-576 (env vars critical)
    likelihood: MEDIUM (depends on deployment process)
    mitigation: |
      Fail build if required environment variables missing. Add startup validation
      in frontend. Prevent checkout if location/terminal invalid.

release_blockers:
  
  - reason: "Admin panel non-functional (HIGH severity)"
    description: |
      Managers cannot manage products, users, inventory, or view reports from UI.
      Backend APIs exist but frontend shows mock data. Critical operational
      capability missing.
    recommendation: |
      BLOCK RELEASE until admin panel connected to backend OR comprehensive API
      documentation provided with training for managers. Current state makes
      system unusable for day-to-day operations.
    sparc_reference: "domains.product_catalog, domains.reporting_and_analytics"
  
  - reason: "No receipt printing (HIGH severity)"
    description: |
      Cashiers cannot print receipts for customers. Violates basic retail POS
      expectations. Backend API works but frontend never calls it.
    recommendation: |
      BLOCK RELEASE until receipt generation integrated into checkout flow.
      Customers must receive proof of purchase. Non-negotiable for retail operations.
    sparc_reference: "workflows.receipt_generation, invariants.receipt_persistence"
  
  - reason: "Tax calculation hardcoded (HIGH severity)"
    description: |
      Tax rate hardcoded at 7% in frontend. Cannot support multiple locations
      with different tax rates. Violates tax compliance requirements.
    recommendation: |
      BLOCK RELEASE for multi-location deployments. Single-location deployments
      with 7% tax rate may proceed with documented limitation. Fix required for
      scalability.
    sparc_reference: "invariants.tax_calculation, domains.location_management"
  
  - reason: "Webhook security vulnerability (HIGH severity)"
    description: |
      Uber Eats and DoorDash webhooks not authenticated. Risk of fraudulent
      orders and inventory manipulation. Security vulnerability.
    recommendation: |
      BLOCK RELEASE if delivery platform integrations enabled. Implement signature
      verification or disable webhook endpoints. Security risk unacceptable.
    sparc_reference: "workflows.delivery_platform_webhook_processing"
  
  - reason: "Database single point of failure (HIGH severity)"
    description: |
      PostgreSQL failure causes complete system outage. No automatic failover.
      Violates availability target.
    recommendation: |
      CONDITIONAL BLOCK: Acceptable for pilot/single-store deployment with
      documented manual recovery procedures. BLOCK for multi-store or
      high-availability requirements. Implement failover before production scale.
    sparc_reference: "non_functional.availability.single_point_of_failure"

# ==============================================================================
# SUMMARY
# ==============================================================================
summary:
  total_gaps: 21
  total_violations: 4
  total_risks: 10
  total_release_blockers: 5
  
  critical_findings:
    - "Admin panel is UI-only facade with no backend integration"
    - "Receipt printing not implemented in frontend"
    - "Tax calculation violates multi-location requirement"
    - "Webhook security vulnerability (no signature verification)"
    - "Database single point of failure"
  
  production_readiness: "NOT READY"
  
  recommendation: |
    System has solid backend implementation with comprehensive APIs, reliability
    mechanisms, and observability. However, frontend integration is incomplete:
    
    BLOCKERS:
    1. Admin panel must be connected to backend or API documentation provided
    2. Receipt printing must be integrated into checkout flow
    3. Tax calculation must fetch from backend (multi-location support)
    4. Webhook signature verification must be implemented
    5. Database failover required for high-availability deployments
    
    ACCEPTABLE FOR PILOT:
    - Single-location deployment with 7% tax rate
    - Manual admin operations via API docs
    - No delivery platform integrations
    - Documented manual recovery procedures
    - Low-traffic environment (<100 transactions/day)
    
    REQUIRED FOR PRODUCTION:
    - Fix all HIGH severity gaps and violations
    - Complete frontend-backend integration
    - Implement missing security controls
    - Test offline mode thoroughly
    - Verify backup restore procedures
    - Deploy with database failover

# ==============================================================================
# END OF COMPLIANCE ANALYSIS
# ==============================================================================

